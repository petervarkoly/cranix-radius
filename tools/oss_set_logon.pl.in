#!/usr/bin/perl 

BEGIN { push @INC, "/usr/share/oss/lib" }

use strict;
use oss_utils;
use oss_base;
use Data::Dumper;

my $uid = shift;
my $mac = shift;
my @changes  = ();
my @delconf  = ();
my $result   = undef;

$mac =~ s/-/:/g;

my $oss = oss_base->new( { aDN => "cn=ossradius,ou=daemonadmins,LDAPBASE", aPW => "PASSWORD" } );

my $udn = $oss->get_user_dn($uid);
my $wdn = $oss->get_host($mac);
my $ip  = $oss->get_ip_of_host($wdn);
my $ue  = $oss->get_entry( $udn, 1 );

if ($oss->{SYSCONFIG}->{SCHOOL_DEBUG} eq 'yes')
{
	print STDERR "$udn : $wdn : $mac : $ip\n";
	system("date >> /tmp/radius");
	system("echo '$udn : $wdn : $mac : $ip ' >> /tmp/radius");
	my $envr='';
	foreach my $i ( keys %ENV )
	{
		$envr .= $i.'->'.$ENV{$i}."\n";
	}
	system("echo '$envr' >> /tmp/radius");
}
#On a WLAN device only one user can be logged in. 
#Delete the other entries
$result  = $oss->{LDAP}->search(
        base   => $oss->{SYSCONFIG}->{USER_BASE},
        scope  => 'one',
        filter => "configurationValue=LOGGED_ON=$ip"
);
if( $result->code )
{
        $oss->ldap_error($result);
        print STDERR $oss->{ERROR}->{code}."\n";
        print STDERR $oss->{ERROR}->{text}."\n";
}
else
{
	foreach my $entry ( $result->entries )
	{
	    $oss->{LDAP}->modify( $entry->dn, delete => { configurationValue => "LOGGED_ON=$ip" } );
	}
}

$result = $oss->{LDAP}->modify( $udn , add => { configurationValue => "LOGGED_ON=$ip" } );
if( $result->code )
{
	$oss->ldap_error($result);
	print STDERR $oss->{ERROR}->{code}."\n";
	print STDERR $oss->{ERROR}->{text}."\n";
}

$oss->destroy;

